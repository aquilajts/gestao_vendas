<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Contratação - Monte seu Plano</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-900 text-white font-sans min-h-screen flex flex-col items-center justify-center px-4">
  <div class="max-w-4xl w-full">
    <h1 class="text-3xl font-bold text-center mb-8">Monte seu plano</h1>

    <!-- Etapa 1: Serviços Principais -->
    <div id="etapa1" class="space-y-8">
      <h2 class="text-xl font-semibold mb-4">Serviços Inclusos</h2>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- Guincho -->
        <div class="bg-white text-black rounded p-4">
          <h3 class="font-bold mb-2">Guincho</h3>
          <label class="block"><input type="radio" name="guincho" value="0"> 200KM (R$0,00)</label>
          <label class="block"><input type="radio" name="guincho" value="30"> 400KM (R$30,00)</label>
          <label class="block"><input type="radio" name="guincho" value="50"> 800KM (R$50,00)</label>
        </div>

        <!-- Proteção Terceiros -->
        <div class="bg-white text-black rounded p-4">
          <h3 class="font-bold mb-2">Proteção a Terceiros</h3>
          <label class="block"><input type="radio" name="terceiros" value="0"> R$40.000 (R$0,00)</label>
          <label class="block"><input type="radio" name="terceiros" value="30"> R$70.000 (R$30,00)</label>
        </div>

        <!-- Rastreador -->
        <div class="bg-white text-black rounded p-4">
          <h3 class="font-bold mb-2">Rastreador</h3>
          <label class="block"><input type="radio" name="rastreador" value="0"> Não</label>
          <label class="block"><input type="radio" name="rastreador" value="30"> Sim (R$30,00)</label>
        </div>
      </div>

      <div class="flex justify-end">
        <button onclick="irParaEtapa2()" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white py-2 px-6 rounded font-semibold">Próxima</button>
      </div>
    </div>

    <!-- Etapa 2: Adicionais -->
    <div id="etapa2" class="space-y-8 hidden">
      <h2 class="text-xl font-semibold mb-4">Adicionais</h2>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- VFLR -->
        <div class="bg-white text-black rounded p-4">
          <h3 class="font-bold mb-2">Vidros, Faróis, Lanternas e Retrovisores</h3>
          <label class="block"><input type="radio" name="vflr" value="0"> Não (R$0,00)</label>
          <label class="block"><input type="radio" name="vflr" value="20"> Sim (R$20,00)</label>
        </div>

        <!-- Incêndio e Alagamento -->
        <div class="bg-white text-black rounded p-4">
          <h3 class="font-bold mb-2">Incêndio e Alagamento</h3>
          <label class="block"><input type="radio" name="incendio" value="0"> Não (R$0,00)</label>
          <label class="block"><input type="radio" name="incendio" value="25"> Sim (R$25,00)</label>
        </div>

        <!-- Proteção Baú -->
        <div class="bg-white text-black rounded p-4">
          <h3 class="font-bold mb-2">Proteção para Baú (se aplicável)</h3>
          <label class="block"><input type="radio" name="bau" value="0"> Não (R$0,00)</label>
          <label class="block"><input type="radio" name="bau" value="90"> Sim (R$90,00)</label>
        </div>
      </div>

      <div class="flex justify-between">
        <button onclick="voltarEtapa1()" class="mt-4 bg-gray-600 hover:bg-gray-700 text-white py-2 px-6 rounded font-semibold">Voltar</button>
        <button onclick="irParaEtapa3()" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white py-2 px-6 rounded font-semibold">Próxima</button>
      </div>
    </div>

    <!-- Etapa 3: Adesivo -->
    <div id="etapa3" class="space-y-6 hidden">
      <h2 class="text-xl font-semibold mb-4">Adesivo</h2>

      <label class="flex items-center gap-2">
        <input type="checkbox" id="adesivo" class="form-checkbox text-blue-500">
        Aceito adesivar meu veículo e ganhar benefícios
      </label>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <label class="bg-white text-black rounded p-4 block">
          <input type="checkbox" name="beneficio" value="-20"> Desconto mensal de R$ 20,00
        </label>
        <label class="bg-white text-black rounded p-4 block">
          <input type="checkbox" name="beneficio" value="-20"> VFLR incluso gratuitamente
        </label>
        <label class="bg-white text-black rounded p-4 block">
          <input type="checkbox" name="beneficio" value="0"> R$1.000,00 de desconto na participação
        </label>
      </div>

      <div class="mt-6 text-right">
        <button onclick="irParaEtapa2()" class="mt-4 bg-gray-600 hover:bg-gray-700 text-white py-2 px-6 rounded font-semibold">Voltar</button>
        <button onclick="irParaEtapa4()" class="bg-green-600 hover:bg-green-700 text-white py-2 px-6 rounded font-semibold">Seguir com contratação</button>
      </div>

      <div class="mt-8 bg-gray-800 p-4 rounded">
        <h3 class="text-lg font-semibold mb-2">Subtotal</h3>
        <p id="subtotalSeguro">Seguro: <span class="text-red-400 font-bold">R$ 0,00</span></p>
        <p id="subtotalDesconto">Descontos: <span class="text-green-300 font-bold">- R$ 0,00</span></p>
        <p id="subtotalAdicionais">Adicionais: <span class="text-red-400 font-bold">R$ 0,00</span></p>
      </div>
    </div>

    <!-- Etapa 4: Dados do Cliente -->
    <div id="etapa4" class="space-y-6 hidden">
      <h2 class="text-xl font-semibold mb-4">Preencha seus dados</h2>
    
      <div class="space-y-4">
        <input required id="cliente_nome" class="w-full p-2 rounded bg-gray-800 text-white" placeholder="Nome completo *">
        <input required id="cliente_telefone" class="w-full p-2 rounded bg-gray-800 text-white" placeholder="Telefone com DDD *">
        <input required id="cliente_placa" class="w-full p-2 rounded bg-gray-800 text-white" placeholder="Placa do veículo *">
      </div>
    
      <p class="text-sm text-gray-300 mt-4">
        Preencha todos os campos para seguir com a contratação sem intermédio de um vendedor.<br>
        Se desejar contato com um representante, clique em finalizar após preencher nome, telefone e placa.<br>
        <strong>Não se preocupe</strong>, se houver descontos ou campanhas, iremos contatar!
      </p>
    
      <div class="mt-6 text-right">
        <button onclick="voltarEtapa3()" class="bg-gray-600 hover:bg-gray-700 text-white py-2 px-6 rounded font-semibold">Voltar</button>
        <button onclick="enviarFormulario()" class="bg-green-600 hover:bg-green-700 text-white py-2 px-6 rounded font-semibold">Finalizar</button>
      </div>
    </div>
  </div>

  <script>
    function irParaEtapa2() {
      document.getElementById('etapa1').classList.add('hidden');
      document.getElementById('etapa2').classList.remove('hidden');
      finalizarPlano();
    }

    function voltarEtapa1() {
      document.getElementById('etapa2').classList.add('hidden');
      document.getElementById('etapa1').classList.remove('hidden');
    }
    
    function irParaEtapa3() {
      document.getElementById('etapa2').classList.add('hidden');
      document.getElementById('etapa3').classList.remove('hidden');
      finalizarPlano(); // <-- calcula e exibe valores
    }
    
    function irParaEtapa4() {
      finalizarPlano(); // calcula tudo antes de avançar
      document.getElementById('etapa3').classList.add('hidden');
      document.getElementById('etapa4').classList.remove('hidden');
    }

    function voltarEtapa3() {
      document.getElementById('etapa4').classList.add('hidden');
      document.getElementById('etapa3').classList.remove('hidden');
    }
    
    function enviarFormulario() {
      const nome = document.getElementById("cliente_nome").value.trim();
      const telefone = document.getElementById("cliente_telefone").value.trim();
      const placa = document.getElementById("cliente_placa").value.trim();
    
      if (!nome || !telefone || !placa) {
        alert("Por favor, preencha todos os campos obrigatórios.");
        return;
      }
    
      alert(`Formulário enviado com sucesso!\nNome: ${nome}\nTelefone: ${telefone}\nPlaca: ${placa}`);
    }
    
    function finalizarPlano() {
      const seguroBase = parseFloat(localStorage.getItem("mensalidade_original")) || 0;
      const comDesconto = parseFloat(localStorage.getItem("mensalidade_com_desconto")) || 0;
      const adesivoAtivo = document.getElementById('adesivo').checked;

      let adicionais = 0;
      ['guincho', 'terceiros', 'rastreador', 'vflr', 'incendio', 'bau'].forEach(nome => {
        const selecionado = document.querySelector(`input[name=${nome}]:checked`);
        if (selecionado) adicionais += parseFloat(selecionado.value);
      });

      let desconto = seguroBase - comDesconto;
      let beneficiosSelecionados = [];

      if (adesivoAtivo) {
        const beneficios = document.querySelectorAll('input[name=beneficio]:checked');
        beneficios.forEach(b => {
          desconto += parseFloat(b.value);
          beneficiosSelecionados.push(b.parentElement.textContent.trim());
        });
      }

      const subtotalFinal = comDesconto + adicionais + (desconto < 0 ? 0 : -desconto);
      document.getElementById('subtotalFinal')?.remove(); // evita duplicatas
      const resumo = document.createElement('p');
      resumo.id = 'subtotalFinal';
      resumo.innerHTML = `Subtotal Final: <span class='text-white font-bold'>R$ ${subtotalFinal.toFixed(2)}</span>`;
      document.querySelector('#etapa3 .bg-gray-800').appendChild(resumo);
      document.getElementById('subtotalAdicionais').innerHTML = `Adicionais: <span class='${adicionais > 0 ? 'text-red-400' : 'text-white'} font-bold'>R$ ${adicionais.toFixed(2)}</span>`;

      const total = comDesconto + adicionais + (desconto < 0 ? 0 : -desconto);  // desconto já vem negativo se for benefício

      alert(
        `Plano Finalizado!\n\n` +
        `Mensalidade Original: R$ ${seguroBase.toFixed(2)}\n` +
        `Mensalidade com Desconto: R$ ${comDesconto.toFixed(2)}\n` +
        `Adicionais: R$ ${adicionais.toFixed(2)}\n` +
        `Descontos: - R$ ${desconto.toFixed(2)}\n` +
        `\nSubtotal Final: R$ ${total.toFixed(2)}\n` +
        `\nBenefícios Selecionados: ${beneficiosSelecionados.join(', ') || 'Nenhum'}`
      );

    document.querySelectorAll('input[name="beneficio"]').forEach(checkbox => {
      checkbox.addEventListener('change', () => {
        const selecionados = document.querySelectorAll('input[name="beneficio"]:checked');
        if (selecionados.length > 2) {
          checkbox.checked = false;
          alert("Você pode escolher apenas 2 benefícios.");
        }
      });
    });

    window.onload = () => {
      const original = parseFloat(localStorage.getItem("mensalidade_original")) || 0;
      const desconto = parseFloat(localStorage.getItem("mensalidade_com_desconto")) || 0;
      const rastreadorMarcado = localStorage.getItem("rastreador_checkbox") === "true";
      const adesivoMarcado = localStorage.getItem("adesivo_checkbox") === "true";
      const planoBasico = localStorage.getItem("plano_basico") === "true";
  
      if (rastreadorMarcado) {
        document.querySelector('input[name="rastreador"][value="30"]').checked = true;
      } else {
        document.querySelector('input[name="rastreador"][value="0"]').checked = true;
      }
  
      document.getElementById('adesivo').checked = adesivoMarcado;
      const beneficios = document.querySelectorAll('input[name="beneficio"]');
      beneficios.forEach(opt => opt.disabled = !adesivoMarcado);
  
      if (planoBasico) {
        document.querySelector('input[name="guincho"][value="0"]').checked = true;
        document.querySelector('input[name="terceiros"][value="0"]').checked = true;
        document.querySelector('input[name="vflr"][value="0"]').checked = true;
        document.querySelector('input[name="incendio"][value="0"]').checked = true;
        document.querySelector('input[name="bau"][value="0"]').checked = true;
  
        document.getElementById('etapa1').classList.add('hidden');
        document.getElementById('etapa2').classList.add('hidden');
        document.getElementById('etapa3').classList.remove('hidden');
      }
  
      document.getElementById('subtotalSeguro').innerHTML = `Seguro: <span class='text-red-400 font-bold'>R$ ${original.toFixed(2)}</span>`;
      document.getElementById('subtotalDesconto').innerHTML = `Descontos: <span class='text-green-300 font-bold'>- R$ ${(original - desconto).toFixed(2)}</span>`;
    };

    document.getElementById('adesivo').addEventListener('change', function () {
      const ativo = this.checked;
      const opcoes = document.querySelectorAll('input[name="beneficio"]');
      opcoes.forEach(opt => {
        opt.disabled = !ativo;
        if (!ativo) opt.checked = false;
      });
    });
  </script>
</body>
</html>
